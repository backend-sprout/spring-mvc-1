동시 요청 - 멀티 쓰레드  
=========================   

# 개요 
  
[#](#)    
 
클라이언트에서 서버(WAS)로 요청을 보내면  
클라이언트와 서버(WAS)는 `TCP/IP 커넥션 연결`이 된다. (3Way Hand Shake)      
     
이후, 서버(WAS)는 `Servlet`을 통해 결과값을 얻고 이를 클라이언트에 반환해준다.        
그런데 한 가지 의문점이 `Servlet`에 대해서 우리는 단순히 정의만 해주었는데      
**`누가` Servlet을 객체로 만들고 이를 호출하여 사용하는 것일까? 🤔**     

이에 대한 해답으로 **쓰레드**라고 말할 수 있다.  
     
# 쓰레드        
실행 중인 프로그램을 우리는 프로세스라고 말을 한다.              
하나의 프로세스는 여러 작은 단위의 쓰레드를 가질 수 있다.            
      
쓰레드는, 애플리케이션 코드를 하나하나 순차적으로 실행하는 역할을 하고 있다.       
가장 적절한 비유로 우리가 기본적으로 사용하는 `main()` 메서드도 `Main 쓰레드`에 의해 실행된다.         
이말은 곧, 쓰레드가 없다면 자바 애플리케이션은 수행이 불가능하다는 것을 의미한다.     
     
**쓰레드는 한번에 하나의 코드 라인만을 수행한다.**      
그렇기에 **동시에 여러 요청이 온다면 쓰레드를 추가로 생성해줘야 한다.**        

## 단일 쓰레드 단일 요청
   
[#](#)     
  
쓰레드가 1개만 있다고 가정을 한다.   
클라이언트에서 요청이 오면, WAS 에서는 쓰레드 한 개를 할당을 해서 요청을 처리하도록 한다.   
물론, 요청을 처리한다는 말은 Servlet 을 구동시켜 클라이언트에게 알맞은 응답을 주기 위해 애플리케이션 로직을 실행하는 것이다.    


## 단일 쓰레드 다중 요청  
  
[#](#)  
  
쓰레드는 1개인데 여러 요청이 왔다고 가정한다.        
하나의 쓰레드는 하나의 요청만 처리할 수 있기 때문에 나머지 한 개의 요청은 대기가 된다.       
        
**그런데 만약,** 로직에 문제가 있어 응답 처리 시간이 지연이 된다면        
나머지 요청은 무기한 대기상태에 빠지게 되고    
**timeout 마저 지나면** 2개의 요청 모두 연결이 끊겨 응답이 실패하게 된다.         

[#](#)  
  
위 같은 문제를 해결하기 위한 가장 쉬운 방법은 쓰레드를 새로 생성해서 할당하는 것이다.      

## 요청 마다 쓰레드 생성의 장단점  
**장점**   
* 동시 요청 처리를 할 수 있다.    
* 리소스(CPU, 메모리)가 허용할 때 까지 처리 가능(단 넘치면 다 죽는다.)       
* 하나의 쓰레드가 지연되어도, 나머지 쓰레드는 정상 동작한다.     
  
**단점**       
* **쓰레드 생성 비용은 매우 비싸다**      
  즉, 고객의 요청이 올 때 마다 쓰레드를 생성하면, 응답 속도가 느려진다.    
* **쓰레드는 컨텍스트 스위칭 비용이 발생한다.**      
  사실 CPU는 코어의 갯수 만큼의 쓰레드를 처리할 수 있다. (4코어는 -> 4개의 쓰레드 각각 맡아 동시에 돌린다.)      
  만약, 4코어 기준 8개의 쓰레드를 돌린다면      
  매우 빠른 속도로 CPU는 4개의 쓰레드를 처리하다가 다시 다른 4개의 쓰레드를 바꾸어서 처리하고 이를 반복한다.        
  이렇듯 CPU가 맡은 작업이 전환되는 것을 컨텍스트 스위칭이라하는데 쓰레드가 많을 수록 이 비용이 커진다.(많이 교체하니까)        
* **쓰레드 생성에 제한이 없다.**    
  고객 요청이 너무 많이 오면, CPU/메모리 임계점을 넘어서 서버가 죽을 수 있다.    

## 쓰레드 풀(해결 방법)   
`쓰레드 풀`은 WAS 내부에 존재하며, 쓰레드를 미리 만들어 대기시켜놓았다가      
쓰레드를 필요로 할 때 꺼내서 CPU에게 할당을 해주는 기술을 의미한다.       


[#](#)  

즉, 쓰레드를 미리 만들기에 `매번 생성하는 비용(시간)을 줄이고`     
쓰레드의 갯수 제한도 두어 `리소스를 넘기는 것을 방지` 할 수도 있다.   
    
**그렇다면 쓰레드 풀의 갯수도 초과한 요청이 온다면..? 🤔**     
나머지 요청들은 `대기 제한 수`만큼 대기하고 또 그외 나머지는 연결이 거부된다.   
  
**정리**      
* 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다.  
* 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. (톰캣은 최대 200개 기본 설정-변경가능)       
   
**사용**  
* 쓰레드가 필요하면, 이미 생성되어 있는 쓰레드를 쓰레드 풀에서 꺼내서 사용한다.   
* 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납한다.   
* 최대 쓰레드가 모두 사용중이어서 쓰레드 풀에 쓰레드가 없다면?   
    * 기다리는 요청은 거절하거나 특정 숫자만큼만 대기하도록 설정할 수 있다.  
   
**장점**   
* 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용(CPU)이 절약되고, 응답시간이 빠르다.     
* 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.    




 




  
  
  






